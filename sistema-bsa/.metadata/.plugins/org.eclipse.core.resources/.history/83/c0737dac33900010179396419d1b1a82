package dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.List;

import model.Equipe;
import model.Usuario;
import util.Conexao;

public class EquipeDAO {

    public void cadastrar(Equipe equipe) {
        String sqlEquipe = "INSERT INTO equipes (nome_equipe, descricao) VALUES (?, ?)";
        String sqlUsuarioEquipe = "INSERT INTO usuario_equipe (id_usuario, id_equipe) VALUES (?, ?)";
        
        Connection conexao = null;
        PreparedStatement stmtEquipe = null;
        PreparedStatement stmtUsuarioEquipe = null;
        ResultSet rs = null;

        try {
            conexao = new Conexao().getConexao();
            conexao.setAutoCommit(false);

            stmtEquipe = conexao.prepareStatement(sqlEquipe, Statement.RETURN_GENERATED_KEYS);
            stmtEquipe.setString(1, equipe.getNome());
            stmtEquipe.setString(2, equipe.getDescricao());
            stmtEquipe.executeUpdate();

            rs = stmtEquipe.getGeneratedKeys();
            int idNovaEquipe = -1;
            if (rs.next()) {
                idNovaEquipe = rs.getInt(1);
            }

            if (idNovaEquipe != -1) {
                stmtUsuarioEquipe = conexao.prepareStatement(sqlUsuarioEquipe);
                for (Usuario membro : equipe.getMembros()) {
                    stmtUsuarioEquipe.setInt(1, membro.getId());
                    stmtUsuarioEquipe.setInt(2, idNovaEquipe);
                    stmtUsuarioEquipe.executeUpdate();
                }
            }
            
            conexao.commit();
            System.out.println("Equipe e membros cadastrados com sucesso!");

        } catch (SQLException e) {
            System.out.println("Erro ao cadastrar equipe: " + e.getMessage());
            try {
                // Se deu erro, desfazemos tudo o que foi feito.
                if (conexao != null) conexao.rollback();
            } catch (SQLException ex) {
                System.out.println("Erro ao reverter a transação: " + ex.getMessage());
            }
        } finally {
            try {
                if (rs != null) rs.close();
                if (stmtEquipe != null) stmtEquipe.close();
                if (stmtUsuarioEquipe != null) stmtUsuarioEquipe.close();
                if (conexao != null) {
                    conexao.setAutoCommit(true);
                    conexao.close();
                }
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
    }

    public List<Equipe> listarTodos() {
        List<Equipe> equipes = new ArrayList<>();
        String sqlEquipes = "SELECT * FROM equipes";
        String sqlMembros = "SELECT u.* FROM usuarios u JOIN usuario_equipe ue ON u.id_usuario = ue.id_usuario WHERE ue.id_equipe = ?";

        try (Connection conexao = new Conexao().getConexao();
             PreparedStatement stmtEquipes = conexao.prepareStatement(sqlEquipes);
             ResultSet rsEquipes = stmtEquipes.executeQuery()) {

            while (rsEquipes.next()) {
                Equipe equipe = new Equipe();
                equipe.setId(rsEquipes.getInt("id_equipe"));
                equipe.setNome(rsEquipes.getString("nome_equipe"));
                equipe.setDescricao(rsEquipes.getString("descricao"));

                try (PreparedStatement stmtMembros = conexao.prepareStatement(sqlMembros)) {
                    stmtMembros.setInt(1, equipe.getId());
                    try (ResultSet rsMembros = stmtMembros.executeQuery()) {
                        while (rsMembros.next()) {
                            Usuario membro = new Usuario();
                            membro.setId(rsMembros.getInt("id_usuario"));
                            membro.setNomeCompleto(rsMembros.getString("nome_completo"));
                            membro.setCargo(rsMembros.getString("cargo"));
                            equipe.adicionarMembro(membro);
                        }
                    }
                }
                equipes.add(equipe);
            }
        } catch (SQLException e) {
            System.out.println("Erro ao listar equipes: " + e.getMessage());
        }
        return equipes;
    }
    
}